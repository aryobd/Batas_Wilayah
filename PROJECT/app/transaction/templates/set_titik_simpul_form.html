

<!-- Leaflet -->
    <link rel="stylesheet" href="static/leaflet/leaflet.css">
    <link rel="stylesheet" href="static/leaflet/plugin/leaflet-controllayerstree.css">
 <link rel="stylesheet" href="static/leaflet/plugin/leaflet-fullscreen.min.css">
<style>
    input.leaflet-control-layers-selector {
        opacity: 1 !important;
        position: static !important;
        left: 2px;
        margin-right: 4px;
    }
</style>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<div class="col-lg-12">

    <div class="card card-outline">
        <div class="card-header pb-0">
            <table>
                <tr>
                    <td style="width: 100%;">
                        <div id="title-map" style="display: none;">
                            <div class="font-weight-bold badge badge-danger">ID : #123123</div>

                        </div>

                        <span class="font-weight-bold">Gambar Peta Desa : <span
                                id="gambarDesa-NamaDesa">{{nama_wilayah}}</span>
                        </span>
                        <div>
                    </td>
					<!--
                    <td>
                        <table>
                            <tr>
                                <td>

                                    <button class="btn btn-info  tp-enabled mr-2 d-inline" data-toggle="tooltip"
                                        data-placement="top" title="Upload File"
                                        onclick="$('#modalPilihFile').modal('show')"><i class="mdi mdi-paperclip"></i>
                                    </button>
                                </td>
                                <td> <button id="{{id_button}}"
                                        class="btn btn-primary tp-enabled {{class_button}} d-inline"
                                        data-toggle="tooltip" data-placement="top" title="Simpan Data"
                                        onclick="$('#modalCUpload').modal('show')"><i
                                            class="mdi mdi-content-save"></i></button>

                                </td>
                            </tr>
                        </table>



                    </td>
					-->
                </tr>
            </table>


        </div>
        <div class="card-body">
			<div id="mapGambarBatasDesa" style="width: 100%;height: 60vh;"></div>
            
        </div>
    </div>
    <div id="modalCUpload" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog ">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="topModalLabel">Konfirmasi</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                </div>
                <div class="modal-body">
                    <h5>Lanjutkan Menyimpan Data ?</h5>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-dismiss="modal">Kembali</button>
                    <button type="button" class="btn btn-primary" onclick="saveData()">Ya</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div>
    <div id="modalPilihFile" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog ">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="topModalLabel">Upload File</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-0">
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="inputGroupFile01"
                                aria-describedby="inputGroupFileAddon01">
                            <label class="custom-file-label" for="inputGroupFile01">Pilih File</label>
                        </div>

                    </div>
                    <strong class="text-danger">* Dengan mengupload file akan menghapus data yang digambar
                        sebelumnya</strong>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-dismiss="modal">Kembali</button>
                    <button type="button" class="btn btn-primary" onclick="processFile()">Lanjutkan</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div>
	
	
	
	 <div id="modalPilihtitik" class="modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog " style="max-width: 1000px">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="topModalLabel">Form Titik Simpul</h4>
                    
                </div>
                <div class="modal-body">
                    <div class="form-group row s-filter">
						<label for="password_konfirmasi" class="col-sm-2 col-form-label">Kecamatan</label>
						<div class="col-sm-8">
							<select id="filter_kecamatan" class="form-control">
								<option value="" selected disabled>--Pilih Kecamatan--</option>
							</select>
						</div>
					</div>
					<div class="form-group row s-filter">
						<label for="password_konfirmasi" class="col-sm-2 col-form-label">Desa</label>
						<div class="col-sm-8">
							<select id="filter_desa" class="form-control">
								<option value="" selected disabled>--Pilih Desa--</option>
							</select>
						</div>
						<div class="col-sm-2">
                            <button class="btn btn-block btn-success" onclick="tambahListDesa()"><i class="fas fa-plus mr-1" ></i>Tambah</button>
							
						</div>
					</div>
                    <strong class="text-danger">* Tombol kembali akan menhapus titik sebelumnya</strong>
					<div class="form-group row s-filter">
						<label for="password_konfirmasi" class="col-sm-2 col-form-label">Titik Simpul (geojson)</label>
						<div class="col-sm-8 form-control" id="txtTitikSimpul">	
						</div>	

					
					</div>
					<div class="form-group row s-filter">
						<label for="password_konfirmasi" class="col-sm-2 col-form-label">No</label>
						<div class="col-sm-8 form-control" id="txtNo">	
						</div>	

					
					</div>
					<div class="form-group row s-filter">
						<label for="password_konfirmasi" class="col-sm-2 col-form-label">Keterangan</label>
						<div class="col-sm-8">	
							<textarea id="txtKeterangan" class="form-control"></textarea>
						</div>						
					</div>
					<div class="form-group row s-filter">
						<label for="password_konfirmasi" class="col-sm-2 col-form-label">List Desa </label>
						<div class="col-sm-8" id="txtDesa">	
						</div>						
					</div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-dismiss="modal" onclick="closeFormtitik()">Kembali</button>
                    <button type="button" class="btn btn-primary" onclick="processForm()">Lanjutkan</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div>
	
	
</div>


	

    <script src="static/leaflet/leaflet-src.js"></script>
   
		
    <script src="static/leaflet/plugin/leaflet-controllayerstree.js"></script>
    <script src="static/leaflet/plugin/leaflet-fullscreen.min.js"></script>
   
   
<script src="static/leaflet/esri-leaflet.js"></script>

    
    <script src="static/leaflet/draw/src/Leaflet.draw.js"></script>
    <script src="static/leaflet/draw/src/Leaflet.Draw.Event.js"></script>
    <link rel="stylesheet" href="static/leaflet/draw/src/leaflet.draw.css"/>

    <script src="static/leaflet/draw/src/Toolbar.js"></script>
    <script src="static/leaflet/draw/src/Tooltip.js"></script>

    <script src="static/leaflet/draw/src/ext/GeometryUtil.js"></script>
    <script src="static/leaflet/draw/src/ext/LatLngUtil.js"></script>
    <script src="static/leaflet/draw/src/ext/LineUtil.Intersect.js"></script>
    <script src="static/leaflet/draw/src/ext/Polygon.Intersect.js"></script>
    <script src="static/leaflet/draw/src/ext/Polyline.Intersect.js"></script>
    <script src="static/leaflet/draw/src/ext/TouchEvents.js"></script>

    <script src="static/leaflet/draw/src/draw/DrawToolbar.js"></script>
    <script src="static/leaflet/draw/src/draw/handler/Draw.Feature.js"></script>
    <script src="static/leaflet/draw/src/draw/handler/Draw.SimpleShape.js"></script>
    <script src="static/leaflet/draw/src/draw/handler/Draw.Polyline.js"></script>
    <script src="static/leaflet/draw/src/draw/handler/Draw.Marker.js"></script>
    <script src="static/leaflet/draw/src/draw/handler/Draw.Circle.js"></script>
    <script src="static/leaflet/draw/src/draw/handler/Draw.CircleMarker.js"></script>
    <script src="static/leaflet/draw/src/draw/handler/Draw.Polygon.js"></script>
    <script src="static/leaflet/draw/src/draw/handler/Draw.Rectangle.js"></script>


    <script src="static/leaflet/draw/src/edit/EditToolbar.js"></script>
    <script src="static/leaflet/draw/src/edit/handler/EditToolbar.Edit.js"></script>
    <script src="static/leaflet/draw/src/edit/handler/EditToolbar.Delete.js"></script>

    <script src="static/leaflet/draw/src/Control.Draw.js"></script>

    <script src="static/leaflet/draw/src/edit/handler/Edit.Poly.js"></script>
    <script src="static/leaflet/draw/src/edit/handler/Edit.SimpleShape.js"></script>
    <script src="static/leaflet/draw/src/edit/handler/Edit.Rectangle.js"></script>
    <script src="static/leaflet/draw/src/edit/handler/Edit.Marker.js"></script>
    <script src="static/leaflet/draw/src/edit/handler/Edit.CircleMarker.js"></script>
    <script src="static/leaflet/draw/src/edit/handler/Edit.Circle.js"></script>


<script>
var map

	var idDesa1 = "{{desa1}}";
	 
	 var idDesa2 = "{{desa2}}";
		var editorDesaIdWilayah = "{{id_wilayah}}";

	
	 var klaimidDesa1 = "{{klaimidDesa1}}";
	 
	 var klaimidDesa2 = "{{klaimidDesa2}}";

    // feature leaflet dara data json
    var datageo

    var Esri_WorldImagery = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, ' +
            'AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    });

    var Esri_DarkGreyCanvas = L.tileLayer(
        "http://{s}.sm.mapstack.stamen.com/" +
        "(toner-lite,$fff[difference],$fff[@23],$fff[hsl-saturation@20])/" +
        "{z}/{x}/{y}.png",
        {
            attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, ' +
                'NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
        }
    );

    var Apimaxbox = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
            'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        id: 'mapbox/light-v9',
        tileSize: 512,
        zoomOffset: -1
    });
   
   


    var layer_rbiesri = L.esri.tiledMapLayer({
        url: 'https://portal.ina-sdi.or.id/arcgis/rest/services/RBI/Basemap/MapServer',
        opacity: 1
    })
	
	
	var layer_indikatif = L.esri.dynamicMapLayer({
        url: 'https://geoservices.big.go.id/rbi/rest/services/BATASWILAYAH/Administrasi_AR_KelDesa_10K/MapServer',
        opacity: 1
    })

	


    var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    var layersTree = [
        {
            label: 'Base Map',
            children: [

                { label: 'RBI BIG - Esri', layer: layer_rbiesri },
				{ label: 'Satellite ESRI', layer: Esri_WorldImagery },
				{ label: 'Grey Canvas ESRI', layer: Esri_DarkGreyCanvas },
				{ label: 'Mapbox', layer: Apimaxbox },
					{ label: 'OpenStreetMap_Mapnik', layer: OpenStreetMap_Mapnik },
            ]
        }]

    map = L.map('mapGambarBatasDesa', {
        layers: [OpenStreetMap_Mapnik],
        //pmIgnore: false,
       // maxZoom: 17,
       // fullscreenControl: true,
       // fullscreenControlOptions: {
      //      position: 'topleft'
      //  }
    }).setView([-6.491857302, 106.848663298], 15);
	
	
	
	
		var overlayMaps = {
			//"Indikatif": layer_indikatif
			label: 'Indikatif',
            children: [
                { label: 'Indikatif', layer: layer_indikatif },
               
            ]
		};
		
		
		
    var ctr = L.control.layers.tree(layersTree, overlayMaps, {
        //namedToggle: true,
        selectorBack: false,
        closedSymbol: '&#8862; &#x1f5c0;',
        openedSymbol: '&#8863; &#x1f5c1;',
        // collapseAll: 'Collapse all',
        // expandAll: 'Expand all',
        collapsed: true,
    }).addTo(map)





var editableLayers = new L.FeatureGroup();
map.addLayer(editableLayers);


// define custom marker
var MyCustomMarker = L.Icon.extend({
  options: {
    shadowUrl: null,
    iconAnchor: new L.Point(12, 12),
    iconSize: new L.Point(24, 24),
    iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/6/6b/Information_icon4_orange.svg'
  }
});

var drawPluginOptions = {
  position: 'topleft',
  draw: {

	circle: false,
	rectangle: false,
	polygon: false,
	polyline: false,
	circlemarker: false,
    marker: {
      icon: new MyCustomMarker()
    }
  }
  ,
  edit: {
    featureGroup: editableLayers, //REQUIRED!!
    remove: false
  }
};




var drawControl = new L.Control.Draw(drawPluginOptions);
map.addControl(drawControl);


var geojsonPointCreated = {}
var layerCreated 
var arrayIddesatitikSimpul = []

var charGenerateNo = "" 

var sortArrayListDesa = []

var charGenerateNoTemplate = ""

 map.on(L.Draw.Event.CREATED, function (event) {
        var layer = event.layer;
		var type = event.layerType;
		//console.log(event)
		//console.log(layer.getLatLngs())
		geojsonPointCreated = event.layer.toGeoJSON().geometry
		layerCreated = layer
		arrayIddesatitikSimpul = [] 		
		arrayIddesatitikSimpul.push(idDesa1)		
		arrayIddesatitikSimpul.push(idDesa2)
		$('#txtTitikSimpul').html(JSON.stringify(geojsonPointCreated))
		
		sortArrayListDesa = []
		
		sortArrayListDesa.push(idDesa1.substring(4,6)+'.'+idDesa1.substring(6,10))
		sortArrayListDesa.push(idDesa2.substring(4,6)+'.'+idDesa2.substring(6,10))
		
		sortArrayListDesa.sort()
		charGenerateNoTemplate = "TK " + idDesa1.substring(0,2) + "." + idDesa1.substring(2,4) + '.'
		charGenerateNo = charGenerateNoTemplate
		for (var i = 0; i < sortArrayListDesa.length; i++) {
			if (i==0)
				charGenerateNo = charGenerateNo+sortArrayListDesa[i]
			else 
				charGenerateNo = charGenerateNo+'-'+sortArrayListDesa[i]
		}
		
		//charGenerateNo = "TK " + idDesa1.substring(0,2) + "." + idDesa1.substring(2,4) + '.'+sortArrayListDesa[0]+'-'+sortArrayListDesa[1]
		$('#txtNo').html(charGenerateNo+"-000")
		$('#filter_kecamatan').val('')
		$('#filter_desa').html('');
		$('#txtDesa').html('')
		for (var i = 0; i < ListDesaArray.length; i++) {
				$('#txtDesa').append("<br />"+ListDesaArray[i])
				
			}
		//$('#txtDesa').append(klaimidDesa1Nama)
		//$('#txtDesa').append("<br />"+klaimidDesa2Nama)
		$('#modalPilihtitik').show();
		
        editableLayers.addLayer(layer);
    });
map.on('draw:edited', function (e) {
         var layers = e.layers;
		 var datalayeredit = []
         layers.eachLayer(function (layer) {
			var aa = {'id':layer.feature.id,'datajson':JSON.stringify(layer.toGeoJSON().geometry)}
			//console.log(layer.feature.id)
             //do whatever you want; most likely save back to db
			 //console.log(layer.toGeoJSON())
			 datalayeredit.push(aa);
         });
		 processFormE(datalayeredit)
     });
/*
map.on('draw:created', function(e) {
  var type = e.layerType,
    layer = e.layer;

  if (type === 'marker') {
    layer.bindPopup('A popup!');
  }

  //editableLayers.addTo(layer);
  console.log(layer)
});

*/
closeFormtitik = function(){
	 editableLayers.removeLayer(layerCreated)
	$('#modalPilihtitik').hide()
}

tambahListDesa = function(){
    console.log($("#filter_desa").val())
    if( sortArrayListDesa ==null)sortArrayListDesa=[];
	if ($("#filter_desa").val() != ""){
	
		if(jQuery.inArray($("#filter_desa").val(), arrayIddesatitikSimpul) != -1) {
			
            showNotificationParam("info", "Desa tersebut sudah ditambahkan")
		} else {
			arrayIddesatitikSimpul.push($("#filter_desa").val())
			
			var aaa = $("#filter_desa").val()
			
			sortArrayListDesa.push(aaa.substring(4,6)+"."+aaa.substring(6,10))
			sortArrayListDesa.sort()
			charGenerateNo = charGenerateNoTemplate
			for (var i = 0; i < sortArrayListDesa.length; i++) {
				if (i==0)
					charGenerateNo = charGenerateNo+sortArrayListDesa[i]
				else 
					charGenerateNo = charGenerateNo+'-'+sortArrayListDesa[i]
			}
			
			aaa = charGenerateNo
			$('#txtNo').html(aaa+"-000")
			$('#txtDesa').append("<br />"+$("#filter_desa option:selected").text())
			
			console.log(arrayIddesatitikSimpul)
		}
	}
}

function onMapClick1(e) {
  marker = new L.marker(e.latlng, {draggable:'true'});
  marker.on('dragend', function(event){
    var marker = event.target;
    var position = marker.getLatLng();
    marker.setLatLng(new L.LatLng(position.lat, position.lng),{draggable:'true'});
    map.panTo(new L.LatLng(position.lat, position.lng))
  });
  map.addLayer(marker);
};

	var klaimidDesa1Nama = ""
	var klaimidDesa2Nama = ""
var ListDesaArray = []
	loadGeojson = function(){	
		$(".tp-enabled").tooltip('enable')
		setTimeout(function(){ map.invalidateSize()}, 400);
		$.get("transaction/settitikkartometri/geojson?id1="+klaimidDesa1+"&id2="+klaimidDesa2, function(data, status){
			bicycleRental = data.data
			center = data.center
			klaimidDesa1Nama =  data.nama
			var testststs = L.geoJson(bicycleRental, {

				style: function (feature) {
					//return feature.properties && feature.properties.style;
				},
			

				//onEachFeature: onEachFeature,
		
				pointToLayer: function (feature, latlng) {
					
					return L.circleMarker(latlng, {
						radius: 3,
						fillColor: "#ff7800",
						color: "#000",
						weight: 1,
						opacity: 1,
						fillOpacity: 0.8
					});
				}
				,onEachFeature: function(feature, layer) {
					ListDesaArray.push(feature.properties.nama)
					var label = L.marker(layer.getBounds().getCenter(), {
					  icon: L.divIcon({
						className: 'label',
						html: feature.properties.nama,
						iconSize: [100, 40]
					  })
					}).addTo(map);
				  }
				
			})//.addTo(map);
			map.addLayer(testststs);
			//console.log(testststs.getBounds())
			
			center = center.replace("POINT(","").replace(")","")
			splitcenter = center.split(" ")
			
			map.setView([splitcenter[1], splitcenter[0]], 15)
			//map.panTo(testststs.getBounds());
		  });
		
		  
		  $.get("transaction/settitiksimpul/geojson1?id1="+idDesa1+"&id2="+idDesa2, function(data, status){
			bicycleRental = data.data
			center = data.center
			klaimidDesa2Nama =  data.nama
			var testststs = L.geoJSON(bicycleRental, {

				style: function (feature) {
					//return feature.properties && feature.properties.style;
				},
			

				//onEachFeature: onEachFeature,
		
				pointToLayer: function (feature, latlng) {
					var marker = 
					 L.circleMarker(latlng, {					
						radius: 10,
						fillColor: "#ff7800",
						color: "#000",
						weight: 1,
						opacity: 1,
						fillOpacity: 0.8
						
					});
					
					return marker;
				}
				,onEachFeature: function (feature, layer) {
					aa = "<table>"
					aa += "<tr><td colspan=2>TITIK SIMPUL</td></tr>"
					if (feature.properties && feature.properties.no) {
						aa += "<tr><td>No</td><td>"+feature.properties.no+"</td>"
					}
					if (feature.properties && feature.properties.keterangan) {
						aa += "<tr><td>Keterangan</td><td>"+feature.properties.keterangan+"</td>"
					}
					aa += "</table>"
					layer.bindPopup(aa);
					//console.log(layer)
					layer.on('dragend', function(event){
						console.log(event)
						//var marker = event.target;
						//var position = marker.getLatLng();
						//marker.setLatLng(new L.LatLng(position.lat, position.lng),{draggable:'true'});
						//map.panTo(new L.LatLng(position.lat, position.lng))
					  });
					  //map.addLayer(marker);
					//map.on('click', onMapClick);
					editableLayers.addLayer(layer);
				},
				
			})
			//editableLayers.addLayer(testststs);
			//map.addLayer(testststs);
			
		  });
	}
	
	function getSelecteddesa() {
       /* let selectorFilter = ["filter_desa", "filter_kecamatan", "filter_kabkota", "filter_provinsi"]
        let i = 0
        fSelectedIdWilayah = null
        while (fSelectedIdWilayah == null) {
            fSelectedIdWilayah = $("#" + selectorFilter[i]).val()
            // console.log(fSelectedIdWilayah, "#" + selectorFilter[i])
            i++
            if (i > selectorFilter.length ) {
                fSelectedIdWilayah = ""
            }

        }
        // console.log(aa++)
        if (fSelectedIdWilayah.length == 10) {
            $("#btnInsert").attr("disabled", false)
        } else {
            $("#btnInsert").attr("disabled", true)
        }*/
		//console.log('11')
       generateDropdownDesa({ selector: "#filter_desa", parentValue: $('#filter_kecamatan').val() })
    }
	
	generateKecataman = function(parentValue){
		listHtml = '<option value="" selected>--Pilih Kecamatan--</option>'
		$.get("/master/kecamatan/dropdownlist?type=2&id_kabkota=" + parentValue, function( data ) {
			$.each(  data.data, function( key, value ) {
			  listHtml += '<option value="' + value.id + '" >' + value.name + '</option>';
			 
			});
			
			$('#filter_kecamatan').html(listHtml);
			
		});
	}
	
	generatedesa = function(parentValue){
		listHtml = '<option value="" selected>--Pilih Desa--</option>'
		$.get("/master/desa/dropdownlist?type=2&id_kecamatan=" + parentValue, function( data ) {
			$.each(  data.data, function( key, value ) {
			  listHtml += '<option value="' + value.id + '" >' + value.name + '</option>';
			 
			});
			
			$('#filter_desa').html(listHtml);
			
		});
	}
	
	$(document).ready(function() {
		loadGeojson();
		generateKecataman(editorDesaIdWilayah)
		$('#filter_kecamatan').on('change',function(){
			if ($('#filter_kecamatan').val() != ""){
				$('#filter_desa').html('');
				generatedesa($('#filter_kecamatan').val())
			}
		})
    });
	processForm = function(){
		execData('transaction/settitiksimpul/crud',{
      'geom':$('#txtTitikSimpul').html(),      
      'no': $('#txtNo').html(),
      'keterangan': $('#txtKeterangan').val(),
      'listdesa': arrayIddesatitikSimpul
		})
		
	}
	processFormE = function(data){
		execData('transaction/settitiksimpul/crude',{     
      'listdesa': data
		})
		
	}
</script>